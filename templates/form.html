<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation & Invoice Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-200 min-h-screen py-8">
    <!-- Navigation Bar -->
    <div class="navbar bg-base-100 shadow-lg mb-8">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost normal-case text-xl">
                <img src="{{ url_for('static', filename='logo-Remnow.png') }}" alt="Remnow Logo" class="h-8 mr-2">
                Remnow Invoice
            </a>
        </div>
        <div class="flex-none gap-2">
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-neutral-focus text-neutral-content rounded-full w-10">
                        <span class="text-xl">{{ current_user.name[0].upper() }}</span>
                    </div>
                </label>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    <li class="menu-title">
                        <span>{{ current_user.name }}</span>
                        <span class="text-xs">{{ current_user.email }}</span>
                    </li>
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 max-w-4xl">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-3xl mb-6">Quotation & Invoice Generator</h2>
                
                <form id="quotationForm" class="space-y-6">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Quotation No *</span>
                            </label>
                            <input type="text" id="quotation_no" name="quotation_no" placeholder="e.g., INV/25-26/001" 
                                   class="input input-bordered w-full" required />
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Date *</span>
                            </label>
                            <input type="date" id="date" name="date" 
                                   class="input input-bordered w-full" required />
                        </div>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">To (Address) *</span>
                        </label>
                        <textarea id="to_address" name="to_address" rows="3" 
                                  placeholder="Enter recipient address" 
                                  class="textarea textarea-bordered w-full" required></textarea>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Currency *</span>
                        </label>
                        <select id="currency" name="currency" class="select select-bordered w-full" required>
                            <option value="USD">USD ($)</option>
                            <option value="INR">INR (₹)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                        </select>
                    </div>
                    
                    <!-- Items Table -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Items *</span>
                        </label>
                        <div class="overflow-x-auto">
                            <table class="table table-bordered w-full">
                                <thead>
                                    <tr>
                                        <th>Description of Service</th>
                                        <th>HSN Code</th>
                                        <th>Month</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <!-- Items will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" onclick="addItemRow()" class="btn btn-sm btn-primary mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Item
                        </button>
                    </div>
                    
                    <!-- Payment Information -->
                    <div class="divider">Payment Information</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Bank Name</span>
                            </label>
                            <input type="text" id="bank_name" name="bank_name" placeholder="e.g., Canara Bank" 
                                   class="input input-bordered w-full" />
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Branch Name</span>
                            </label>
                            <input type="text" id="branch_name" name="branch_name" placeholder="e.g., Moondrumavadi" 
                                   class="input input-bordered w-full" />
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Account Name</span>
                            </label>
                            <input type="text" id="account_name" name="account_name" placeholder="e.g., Ganga R" 
                                   class="input input-bordered w-full" />
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Account Number</span>
                            </label>
                            <input type="text" id="account_number" name="account_number" placeholder="e.g., 120027532695" 
                                   class="input input-bordered w-full" />
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">IFSC Code</span>
                            </label>
                            <input type="text" id="ifsc_code" name="ifsc_code" placeholder="e.g., CNRB0016209" 
                                   class="input input-bordered w-full" />
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="card-actions justify-end mt-6">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            Generate PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Loading Modal -->
        <div id="loadingModal" class="modal">
            <div class="modal-box">
                <h3 class="font-bold text-lg">Generating PDF...</h3>
                <p class="py-4">Please wait while we generate your quotation PDF.</p>
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
        
        <!-- Success/Error Alert -->
        <div id="alertContainer" class="mt-4"></div>
    </div>
    
    <script>
        let itemCount = 0;
        
        // Add initial row
        addItemRow();
        
        function addItemRow() {
            const tbody = document.getElementById('itemsTableBody');
            const row = document.createElement('tr');
            row.id = `item-row-${itemCount}`;
            row.innerHTML = `
                <td>
                    <input type="text" class="input input-bordered input-sm w-full" 
                           placeholder="Description" name="item_description_${itemCount}" required />
                </td>
                <td>
                    <input type="text" class="input input-bordered input-sm w-full" 
                           placeholder="HSN Code" name="item_hsn_${itemCount}" />
                </td>
                <td>
                    <input type="text" class="input input-bordered input-sm w-full" 
                           placeholder="Month" name="item_month_${itemCount}" />
                </td>
                <td>
                    <input type="text" class="input input-bordered input-sm w-full" 
                           placeholder="Rate" name="item_rate_${itemCount}" />
                </td>
                <td>
                    <input type="number" step="0.01" class="input input-bordered input-sm w-full" 
                           placeholder="Amount" name="item_amount_${itemCount}" required />
                </td>
                <td>
                    <button type="button" onclick="removeItemRow(${itemCount})" class="btn btn-sm btn-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            itemCount++;
        }
        
        function removeItemRow(id) {
            const row = document.getElementById(`item-row-${id}`);
            if (row) {
                row.remove();
            }
        }
        
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    <span>${message}</span>
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
        
        document.getElementById('quotationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading modal
            document.getElementById('loadingModal').classList.add('modal-open');
            
            // Collect form data
            const formData = {
                quotation_no: document.getElementById('quotation_no').value,
                date: document.getElementById('date').value,
                to_address: document.getElementById('to_address').value,
                currency: document.getElementById('currency').value,
                bank_name: document.getElementById('bank_name').value,
                branch_name: document.getElementById('branch_name').value,
                account_name: document.getElementById('account_name').value,
                account_number: document.getElementById('account_number').value,
                ifsc_code: document.getElementById('ifsc_code').value,
                items: []
            };
            
            // Collect items
            for (let i = 0; i < itemCount; i++) {
                const row = document.getElementById(`item-row-${i}`);
                if (row) {
                    const description = row.querySelector(`[name="item_description_${i}"]`)?.value;
                    const hsn = row.querySelector(`[name="item_hsn_${i}"]`)?.value;
                    const month = row.querySelector(`[name="item_month_${i}"]`)?.value;
                    const rate = row.querySelector(`[name="item_rate_${i}"]`)?.value;
                    const amount = row.querySelector(`[name="item_amount_${i}"]`)?.value;
                    
                    if (description && amount) {
                        formData.items.push({
                            description: description,
                            hsn_code: hsn || '',
                            month: month || '',
                            rate: rate || '',
                            amount: amount
                        });
                    }
                }
            }
            
            if (formData.items.length === 0) {
                document.getElementById('loadingModal').classList.remove('modal-open');
                showAlert('Please add at least one item', 'error');
                return;
            }
            
            try {
                // Create quotation
                const response = await fetch('/api/quotation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Generate PDF
                    const pdfResponse = await fetch(`/api/quotation/${result.id}/pdf`);
                    if (pdfResponse.ok) {
                        const blob = await pdfResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `quotation_${formData.quotation_no}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        showAlert('PDF generated successfully!', 'success');
                    } else {
                        throw new Error('Failed to generate PDF');
                    }
                } else {
                    throw new Error(result.error || 'Failed to create quotation');
                }
            } catch (error) {
                showAlert(error.message || 'An error occurred', 'error');
            } finally {
                document.getElementById('loadingModal').classList.remove('modal-open');
            }
        });
        
        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>

